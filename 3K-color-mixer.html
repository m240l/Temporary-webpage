<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>图案调色模拟器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --accent-blue: #007aff;
      --accent-red: #ff3b30;
      --accent-green: #34c759;
      --border-color: #c7c7cc;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-medium: rgba(0, 0, 0, 0.1);
      --ios-bg: #f2f2f7;
      --ios-card: #ffffff;
      --ios-separator: #c6c6c8;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--ios-bg);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    /* 顶部导航栏 */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background-color: var(--ios-card);
      border-bottom: 1px solid var(--ios-separator);
      z-index: 10;
      flex-shrink: 0;
    }

    .app-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .ios-button {
      background: var(--accent-blue);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ios-button:active {
      opacity: 0.8;
      transform: scale(0.98);
    }

    .ios-button.secondary {
      background: transparent;
      color: var(--accent-blue);
      border: 1px solid var(--accent-blue);
    }

    /* 主内容区域 - 响应式布局 */
    .main-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    /* 桌面端布局 */
    @media (min-width: 768px) {
      .main-content {
        flex-direction: row;
        padding: 20px;
        gap: 20px;
      }
    }

    /* 预览区域 */
    .preview-section {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      min-height: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      position: relative;
      overflow: hidden;
    }

    /* 桌面端预览区域 */
    @media (min-width: 768px) {
      .preview-section {
        flex: 1.5;
        border-radius: 12px;
        margin: 0;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
    }

    .preview-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* 移动端预览容器 - 3:4比例 */
    .preview-wrapper {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 3/4;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      background: var(--ios-card);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* 桌面端预览容器 */
    @media (min-width: 768px) {
      .preview-wrapper {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        padding: 30px;
      }
    }

    .canvas-wrapper {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 2px;
      border-radius: 8px;
      overflow: hidden;
    }

    .canvas-wrapper svg {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* 控制面板容器 */
    .controls-container {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* 移动端控制面板 */
    @media (max-width: 767px) {
      .controls-container {
        flex: 0 0 auto;
        max-height: 60vh;
      }
    }

    /* 桌面端控制面板 */
    @media (min-width: 768px) {
      .controls-container {
        flex: 1;
        min-width: 0;
        max-width: 400px;
        background: var(--ios-card);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow-y: auto;
      }
    }

    /* 控制面板 */
    .controls-panel {
      background: var(--ios-card);
      overflow: hidden;
    }

    /* 移动端控制面板折叠样式 */
    @media (max-width: 767px) {
      .controls-panel {
        border-top: 1px solid var(--ios-separator);
        border-bottom: 1px solid var(--ios-separator);
        margin-top: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .controls-panel.collapsed {
        max-height: 60px;
      }
      
      .controls-panel.expanded {
        max-height: 60vh;
        overflow-y: auto;
      }
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      cursor: pointer;
      user-select: none;
    }

    /* 移动端点击反馈 */
    @media (max-width: 767px) {
      .panel-header:active {
        background-color: rgba(0, 0, 0, 0.04);
      }
    }

    .panel-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .panel-toggle {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    /* 桌面端隐藏折叠按钮 */
    @media (min-width: 768px) {
      .panel-toggle {
        display: none;
      }
    }

    .panel-toggle:active {
      background-color: rgba(0, 0, 0, 0.1);
    }

    .panel-toggle i {
      transition: transform 0.3s ease;
    }

    .controls-panel.expanded .panel-toggle i {
      transform: rotate(180deg);
    }

    .panel-content {
      padding: 0 16px 20px 16px;
    }

    /* 桌面端面板内容 */
    @media (min-width: 768px) {
      .panel-content {
        padding: 0;
        margin-top: 20px;
      }
    }

    /* 控制组 */
    .control-group {
      margin-bottom: 24px;
    }

    .control-group-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 0 12px 0;
      padding: 0 4px;
    }

    /* 颜色控制 */
    .color-controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .color-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }

    .color-label {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      font-size: 16px;
      font-weight: 400;
      color: var(--text-primary);
    }

    .color-label i {
      width: 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .color-preview {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 2px solid var(--ios-separator);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .color-preview:active {
      transform: scale(0.95);
    }

    /* 滑块控制 */
    .slider-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .slider-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slider-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 400;
      color: var(--text-primary);
    }

    .slider-label i {
      width: 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .slider-value {
      font-size: 15px;
      font-weight: 500;
      color: var(--accent-blue);
      min-width: 40px;
      text-align: right;
    }

    .ios-slider {
      width: 100%;
      height: 32px;
      -webkit-appearance: none;
      background: transparent;
      outline: none;
    }

    .ios-slider::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      background: #e5e5ea;
      border-radius: 2px;
    }

    .ios-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent-blue);
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.4);
      margin-top: -12px;
    }

    /* 导出设置 */
    .export-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .export-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .export-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0;
    }

    .ios-checkbox {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      padding: 8px 0;
    }

    .ios-checkbox input[type="checkbox"] {
      display: none;
    }

    .ios-checkbox .checkbox-icon {
      width: 20px;
      height: 20px;
      border-radius: 5px;
      border: 2px solid var(--ios-separator);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .ios-checkbox input[type="checkbox"]:checked + .checkbox-icon {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
    }

    .ios-checkbox input[type="checkbox"]:checked + .checkbox-icon::after {
      content: '✓';
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .ios-select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--ios-separator);
      background: var(--ios-card);
      font-size: 16px;
      color: var(--text-primary);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px;
    }

    .custom-size-inputs {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .custom-size-inputs input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--ios-separator);
      font-size: 16px;
      color: var(--text-primary);
      background: var(--ios-card);
    }

    /* 图片预览模态框 */
    .image-preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
    }

    .image-preview-modal.show {
      display: flex;
    }

    .image-preview-container {
      max-width: 90%;
      max-height: 80%;
      position: relative;
    }

    .image-preview-container img {
      width: 100%;
      height: auto;
      max-height: 70vh;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }

    .save-instructions {
      color: white;
      text-align: center;
      margin-top: 20px;
      font-size: 15px;
      padding: 0 20px;
      line-height: 1.5;
      opacity: 0.8;
    }

    .save-instructions i {
      margin-right: 8px;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .modal-button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .modal-button:active {
      opacity: 0.8;
      transform: scale(0.98);
    }

    .modal-button.download {
      background: var(--accent-green);
      color: white;
    }

    .modal-button.share {
      background: var(--accent-blue);
      color: white;
    }

    .close-preview {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      backdrop-filter: blur(10px);
    }

    .close-preview:active {
      background: rgba(255, 255, 255, 0.2);
    }

    /* 响应式设计 */
    @media (max-width: 480px) {
      .app-header {
        padding: 10px 12px;
      }
      
      .ios-button {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      .panel-header {
        padding: 14px 12px;
      }
      
      .panel-content {
        padding: 0 12px 16px 12px;
      }
      
      .preview-wrapper {
        padding: 15px;
      }
      
      .modal-buttons {
        flex-direction: column;
        width: 100%;
        max-width: 280px;
      }
      
      .modal-button {
        justify-content: center;
      }
    }

    /* 滚动条样式 */
    .controls-container::-webkit-scrollbar,
    .controls-panel::-webkit-scrollbar {
      width: 4px;
    }

    .controls-container::-webkit-scrollbar-track,
    .controls-panel::-webkit-scrollbar-track {
      background: transparent;
    }

    .controls-container::-webkit-scrollbar-thumb,
    .controls-panel::-webkit-scrollbar-thumb {
      background: var(--ios-separator);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 顶部导航栏 -->
    <header class="app-header">
      <h1 class="app-title">图案调色</h1>
      <div class="header-actions">
        <button class="ios-button secondary" id="resetBtn">
          <i class="fas fa-undo"></i> 重置
        </button>
        <button class="ios-button" id="exportBtn">
          <i class="fas fa-download"></i> 导出
        </button>
      </div>
    </header>

    <!-- 主内容区域 -->
    <div class="main-content">
      <!-- 预览区域 -->
      <section class="preview-section">
        <div class="preview-container">
          <div class="preview-wrapper">
            <div class="canvas-wrapper" id="canvas"></div>
          </div>
        </div>
      </section>

      <!-- 控制面板容器 -->
      <div class="controls-container">
        <!-- 控制面板 -->
        <section class="controls-panel expanded" id="controlsPanel">
          <div class="panel-header" id="panelToggle">
            <h2 class="panel-title">编辑控制</h2>
            <button class="panel-toggle">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>
          
          <div class="panel-content">
            <!-- 颜色控制组 -->
            <div class="control-group">
              <h3 class="control-group-title">颜色</h3>
              <div class="color-controls">
                <div class="color-item">
                  <div class="color-label">
                    <i class="fas fa-square"></i>
                    <span>背景色</span>
                  </div>
                  <input type="color" id="bgColor" class="color-preview" value="#f5f0dc" />
                </div>
                
                <div class="color-item">
                  <div class="color-label">
                    <i class="fas fa-heart"></i>
                    <span>红色图案</span>
                  </div>
                  <input type="color" id="redColor" class="color-preview" value="#c1443c" />
                </div>
                
                <div class="color-item">
                  <div class="color-label">
                    <i class="fas fa-leaf"></i>
                    <span>绿色图案</span>
                  </div>
                  <input type="color" id="greenColor" class="color-preview" value="#4a7c59" />
                </div>
              </div>
            </div>

            <!-- 效果控制组 -->
            <div class="control-group">
              <h3 class="control-group-title">效果</h3>
              <div class="slider-controls">
                <div class="slider-item">
                  <div class="slider-header">
                    <div class="slider-label">
                      <i class="fas fa-adjust"></i>
                      <span>透明度</span>
                    </div>
                    <span class="slider-value" id="opacityValue">1.0</span>
                  </div>
                  <input type="range" class="ios-slider" id="opacity" min="0" max="1" step="0.05" value="1" />
                </div>
                
                <div class="slider-item">
                  <div class="slider-header">
                    <div class="slider-label">
                      <i class="fas fa-tint"></i>
                      <span>灰度</span>
                    </div>
                    <span class="slider-value" id="grayscaleValue">0.0</span>
                  </div>
                  <input type="range" class="ios-slider" id="grayscale" min="0" max="1" step="0.05" value="0" />
                </div>
              </div>
            </div>

            <!-- 导出控制组 -->
            <div class="control-group">
              <h3 class="control-group-title">导出</h3>
              <div class="export-controls">
                <div class="export-group">
                  <h4 class="export-title">导出选项</h4>
                  <label class="ios-checkbox">
                    <input type="checkbox" id="includeFrame" />
                    <div class="checkbox-icon"></div>
                    <span>包含外边框</span>
                  </label>
                  <label class="ios-checkbox">
                    <input type="checkbox" id="includeInfo" checked />
                    <div class="checkbox-icon"></div>
                    <span>包含参数信息</span>
                  </label>
                </div>
                
                <div class="export-group">
                  <h4 class="export-title">导出尺寸</h4>
                  <select class="ios-select" id="exportSize">
                    <option value="original">原始尺寸</option>
                    <option value="750x1000">750 × 1000 (3:4)</option>
                    <option value="1080x1440" selected>1080 × 1440 (3:4)</option>
                    <option value="1200x1600">1200 × 1600 (3:4)</option>
                    <option value="1500x2000">1500 × 2000 (3:4)</option>
                    <option value="2250x3000">2250 × 3000 (3:4)</option>
                    <option value="3024x4032">3024 × 4032 (3:4)</option>
                    <option value="custom">自定义尺寸</option>
                  </select>
                  
                  <div id="customSize" style="display: none;">
                    <div class="custom-size-inputs">
                      <input type="number" id="customWidth" min="100" max="5000" value="1080" placeholder="宽度" />
                      <input type="number" id="customHeight" min="100" max="5000" value="1440" placeholder="高度" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- 图片预览模态框 -->
  <div class="image-preview-modal" id="imagePreviewModal">
    <button class="close-preview" id="closePreview">
      <i class="fas fa-times"></i>
    </button>
    <div class="image-preview-container">
      <img id="previewImage" src="" alt="生成的图片预览">
    </div>
    <div class="save-instructions" id="saveInstructions">
      <p><i class="fas fa-mobile-alt"></i> 在手机上：长按图片，然后选择"保存到相册"</p>
      <p><i class="fas fa-desktop"></i> 在电脑上：右键点击图片，选择"图片另存为"</p>
    </div>
    <div class="modal-buttons">
      <button class="modal-button download" id="downloadImageBtn">
        <i class="fas fa-download"></i> 下载图片
      </button>
      <button class="modal-button share" id="shareImageBtn">
        <i class="fas fa-share"></i> 分享图片
      </button>
    </div>
  </div>

  <script>
    // DOM元素
    const canvas = document.getElementById("canvas");
    const bgColorInput = document.getElementById("bgColor");
    const redColorInput = document.getElementById("redColor");
    const greenColorInput = document.getElementById("greenColor");
    const opacityInput = document.getElementById("opacity");
    const grayscaleInput = document.getElementById("grayscale");
    const exportBtn = document.getElementById("exportBtn");
    const resetBtn = document.getElementById("resetBtn");
    const includeFrame = document.getElementById("includeFrame");
    const includeInfo = document.getElementById("includeInfo");
    const exportSize = document.getElementById("exportSize");
    const customSize = document.getElementById("customSize");
    const customWidth = document.getElementById("customWidth");
    const customHeight = document.getElementById("customHeight");
    const controlsPanel = document.getElementById("controlsPanel");
    const panelToggle = document.getElementById("panelToggle");
    
    // 图片预览元素
    const imagePreviewModal = document.getElementById("imagePreviewModal");
    const previewImage = document.getElementById("previewImage");
    const closePreview = document.getElementById("closePreview");
    const downloadImageBtn = document.getElementById("downloadImageBtn");
    const shareImageBtn = document.getElementById("shareImageBtn");
    const saveInstructions = document.getElementById("saveInstructions");

    // 初始值
    const initialValues = {
      bgColor: "#f5f0dc",
      redColor: "#c1443c",
      greenColor: "#4a7c59",
      opacity: 1,
      grayscale: 0
    };

    // SVG定义
    const redSVG = `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="366.000000pt" height="366.000000pt" viewBox="0 0 366.000000 366.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,366.000000) scale(0.100000,-0.100000)"
fill="CURRENT_COLOR" stroke="none">
<path d="M1071 3021 c-22 -27 -57 -82 -76 -124 -34 -71 -36 -80 -36 -180 l0
-105 -47 -44 c-26 -24 -54 -49 -63 -54 -8 -5 -56 -65 -107 -134 -50 -69 -110
-147 -132 -174 -43 -54 -81 -145 -103 -246 -8 -36 -22 -94 -30 -130 -39 -157
-45 -409 -12 -500 7 -19 21 -64 31 -100 22 -78 51 -118 124 -169 68 -48 248
-141 272 -141 10 0 46 -11 80 -24 83 -31 226 -64 313 -71 39 -4 111 -13 160
-21 152 -24 310 -34 547 -34 187 0 235 -3 268 -16 30 -12 62 -15 123 -12 94 5
157 32 278 119 39 28 83 55 97 62 53 22 82 49 154 143 40 53 87 114 105 137
30 39 59 117 108 291 9 32 23 125 31 205 7 80 19 181 25 224 18 124 -2 248
-61 382 l-22 50 61 119 c34 66 61 124 61 130 0 6 7 25 16 41 22 41 54 134 54
157 0 11 -11 22 -27 28 -16 6 -36 15 -45 20 -33 19 -104 12 -135 -13 -15 -12
-48 -36 -73 -52 -24 -17 -72 -56 -106 -87 -34 -32 -68 -58 -75 -58 -25 1 -123
37 -194 73 -60 30 -87 36 -185 46 -63 6 -124 11 -135 10 -34 -2 -228 19 -280
31 -27 6 -84 10 -125 9 -41 -1 -172 -2 -291 -1 l-216 2 -34 66 c-47 94 -105
155 -167 177 -74 25 -86 23 -131 -32z m168 -123 c53 -58 66 -81 58 -102 -8
-19 -70 -46 -107 -46 -16 0 -42 -11 -58 -25 -51 -43 -62 -31 -42 50 6 22 14
60 19 85 5 25 14 58 20 74 10 24 15 27 38 21 14 -3 47 -29 72 -57z m846 -196
c61 -6 171 -10 245 -10 74 0 153 -5 175 -10 74 -20 158 -52 204 -79 57 -33
155 -105 160 -117 2 -5 14 -19 26 -30 11 -12 34 -39 50 -61 16 -22 43 -56 60
-75 81 -90 110 -199 109 -405 -2 -161 -15 -271 -44 -353 -11 -31 -34 -104 -51
-162 -38 -127 -56 -164 -125 -256 -60 -80 -107 -125 -163 -153 -21 -11 -76
-45 -121 -76 -79 -52 -84 -54 -106 -40 -27 17 -56 19 -70 5 -14 -14 -218 -49
-287 -49 -31 0 -70 7 -85 14 -49 26 -132 39 -158 24 -33 -17 -313 -6 -374 15
-25 9 -65 16 -89 16 -24 0 -71 4 -105 9 -33 6 -96 15 -139 21 -118 17 -218 51
-369 123 -169 80 -226 129 -253 214 -10 32 -24 78 -32 103 -8 25 -17 98 -20
163 -6 124 -1 159 43 317 13 47 24 94 24 106 0 41 78 202 126 262 27 33 65 81
84 107 36 50 98 113 218 223 76 69 164 126 229 148 52 18 120 9 134 -17 12
-23 48 -25 54 -4 3 8 7 21 9 28 4 15 475 15 641 -1z m925 -104 c-6 -13 -15
-35 -21 -50 -12 -31 -39 -37 -59 -14 -21 26 -8 57 30 71 54 19 61 18 50 -7z"/>
<path d="M1314 2294 c-89 -61 -221 -179 -240 -216 -19 -37 -18 -45 11 -64 41
-27 92 -6 148 60 49 56 97 86 141 86 35 0 72 -31 139 -115 35 -43 64 -45 78
-7 5 15 19 34 30 43 18 14 20 20 10 55 -9 33 -19 45 -67 72 -31 18 -67 35 -80
38 -14 4 -30 14 -37 24 -12 17 -68 50 -85 50 -5 0 -27 -12 -48 -26z"/>
<path d="M2293 2166 c-21 -18 -64 -50 -96 -71 -74 -47 -97 -90 -70 -135 9 -16
23 -32 31 -35 16 -6 47 26 86 89 36 60 61 76 128 83 48 5 55 3 78 -21 13 -15
29 -41 35 -59 11 -36 29 -43 68 -28 51 20 29 93 -46 155 -83 68 -155 76 -214
22z"/>
<path d="M1750 1725 c-63 -6 -134 -19 -156 -28 -66 -24 -140 -83 -178 -142
-33 -49 -36 -59 -36 -127 1 -62 6 -83 33 -138 l32 -64 90 -35 c88 -35 93 -35
240 -35 l150 -1 90 37 c163 68 213 162 169 317 -24 84 -43 117 -94 165 -73 69
-114 75 -340 51z m251 -94 c37 -25 105 -123 119 -171 11 -40 -4 -93 -40 -133
-52 -60 -224 -101 -367 -87 -164 15 -243 77 -243 191 0 60 10 83 59 128 78 72
178 101 347 98 77 -2 96 -5 125 -26z"/>
<path d="M1655 1516 c-33 -33 -44 -110 -20 -136 30 -33 62 -26 85 20 27 53 26
104 -2 124 -29 21 -35 20 -63 -8z"/>
<path d="M1892 1503 c-31 -25 -40 -101 -17 -137 32 -49 78 -24 89 49 13 84
-23 128 -72 88z"/>
<path d="M744 1655 c-30 -66 -27 -101 12 -111 18 -5 32 0 48 16 21 19 23 29
21 83 -4 58 -5 62 -30 65 -22 3 -29 -3 -51 -53z"/>
<path d="M905 1637 c2 -64 9 -77 40 -77 31 0 48 32 40 73 -10 44 -23 57 -55
57 -27 0 -27 -1 -25 -53z"/>
<path d="M1030 1664 c6 -14 10 -36 10 -49 0 -27 30 -95 41 -95 18 0 39 34 39
65 0 25 -9 42 -36 69 -44 44 -68 48 -54 10z"/>
<path d="M2594 1591 c2 -69 13 -86 49 -77 25 6 37 30 37 74 0 42 32 22 44 -28
9 -38 15 -45 39 -48 34 -4 42 13 33 72 -8 53 -15 56 -123 63 l-82 6 3 -62z"/>
<path d="M2453 1604 c-7 -19 3 -99 17 -124 15 -28 45 -25 69 6 12 15 21 30 21
34 0 3 -14 28 -31 53 -32 48 -64 61 -76 31z"/>
</g>
</svg>`;

    const greenSVG = `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="315.000000pt" height="315.000000pt" viewBox="0 0 315.000000 315.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,315.000000) scale(0.100000,-0.100000)"
fill="CURRENT_COLOR" stroke="none">
<path d="M761 2716 c-11 -13 -9 -21 9 -51 22 -35 22 -36 3 -63 -16 -24 -18
-50 -18 -257 0 -159 -4 -236 -12 -250 -6 -11 -21 -108 -33 -215 -33 -303 -68
-517 -97 -585 -47 -114 -83 -358 -87 -600 -2 -99 -7 -192 -11 -207 -5 -21 -3
-27 15 -33 39 -12 49 11 49 120 0 55 -2 134 -5 175 -8 122 50 466 100 593 14
34 28 89 31 122 4 33 11 79 16 103 11 51 33 216 53 403 9 75 21 149 28 165 8
20 12 98 13 252 0 187 2 224 15 232 8 5 22 7 30 4 53 -19 458 -35 1025 -40
468 -3 629 -13 655 -40 27 -28 36 -396 11 -428 -5 -6 -11 -36 -15 -66 -8 -63
-65 -383 -101 -570 -36 -185 -36 -194 -49 -548 l-11 -327 -70 -7 c-38 -4 -216
-10 -395 -12 -179 -3 -359 -10 -400 -16 -41 -7 -104 -13 -140 -16 -36 -2 -87
-8 -115 -14 -61 -12 -284 -31 -420 -35 -113 -4 -158 -16 -153 -42 5 -29 48
-44 105 -38 28 3 95 10 150 16 54 5 127 12 163 14 36 2 144 11 240 20 96 8
274 20 395 25 121 5 240 13 265 17 25 4 159 7 298 8 270 0 272 0 272 50 0 39
-16 50 -68 48 l-49 -2 -2 162 c-3 317 18 584 63 787 25 108 55 279 71 395 9
62 23 120 32 135 15 21 17 52 17 190 1 91 -3 185 -8 210 -11 56 -50 109 -94
127 -57 24 -315 33 -482 18 -80 -8 -197 -12 -260 -10 -63 2 -245 9 -405 14
-323 11 -430 22 -513 52 -86 31 -97 32 -111 15z"/>
<path d="M1000 2154 c0 -33 23 -55 94 -89 52 -25 76 -42 80 -58 3 -12 31 -42
63 -67 98 -77 146 -132 226 -254 47 -72 56 -88 61 -117 8 -37 37 -68 66 -71
20 -3 28 5 43 37 10 22 28 50 39 61 10 12 32 48 47 80 20 42 47 76 94 117 92
80 186 143 251 167 48 18 60 20 96 9 24 -7 44 -9 48 -3 14 16 34 85 28 92 -12
12 -138 1 -179 -15 -73 -29 -199 -124 -308 -233 -58 -58 -112 -115 -120 -127
-20 -31 -39 -32 -58 -2 -60 96 -174 226 -262 299 -23 19 -63 56 -88 82 -73 73
-221 136 -221 92z"/>
<path d="M1939 1574 c-13 -15 -41 -37 -61 -50 -45 -29 -57 -64 -34 -99 9 -13
16 -33 16 -44 0 -52 41 -91 96 -91 18 0 32 12 54 47 17 26 30 54 30 64 0 9 8
27 19 40 15 19 17 36 13 82 -4 51 -8 60 -29 68 -43 16 -78 10 -104 -17z"/>
<path d="M1200 1508 c-65 -68 -75 -101 -40 -133 27 -25 103 -32 134 -12 33
22 56 95 49 157 l-6 50 -38 0 c-34 0 -46 -7 -99 -62z"/>
<path d="M1439 1164 c-91 -69 -193 -168 -221 -213 -21 -33 -21 -34 -2 -48 32
-24 56 -11 117 65 55 68 153 152 176 152 17 0 78 -58 133 -127 48 -61 94 -93
133 -93 11 0 15 10 15 37 0 29 -9 46 -47 88 -27 28 -74 83 -107 123 -76 94
-94 95 -197 16z"/>
</g>
</svg>`;

    // 工具函数
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? [
        parseInt(result[1], 16),
        parseInt(result[2], 16),
        parseInt(result[3], 16)
      ] : [0, 0, 0];
    }

    function rgbToHex(r, g, b) {
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    function blendColorWithBackground(color, bgColor, opacity) {
      const [r1, g1, b1] = hexToRgb(color);
      const [r2, g2, b2] = hexToRgb(bgColor);
      
      const r = Math.round(r1 * opacity + r2 * (1 - opacity));
      const g = Math.round(g1 * opacity + g2 * (1 - opacity));
      const b = Math.round(b1 * opacity + b2 * (1 - opacity));
      
      return rgbToHex(r, g, b);
    }

    function applyGrayscale(color, grayscale) {
      if (grayscale <= 0) return color;
      
      const [r, g, b] = hexToRgb(color);
      const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
      
      const r2 = Math.round(r * (1 - grayscale) + gray * grayscale);
      const g2 = Math.round(g * (1 - grayscale) + gray * grayscale);
      const b2 = Math.round(b * (1 - grayscale) + gray * grayscale);
      
      return rgbToHex(r2, g2, b2);
    }

    // 更新UI显示
    function updateUI() {
      document.getElementById('opacityValue').textContent = parseFloat(opacityInput.value).toFixed(2);
      document.getElementById('grayscaleValue').textContent = parseFloat(grayscaleInput.value).toFixed(2);
    }

    // 渲染图案
    function renderGrid() {
      canvas.innerHTML = "";
      canvas.style.backgroundColor = bgColorInput.value;
      const opacity = parseFloat(opacityInput.value);
      const grayscale = parseFloat(grayscaleInput.value);

      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 6; col++) {
          const isRed = (row + col) % 2 === 0;
          const svgRaw = isRed ? redSVG : greenSVG;
          const color = isRed ? redColorInput.value : greenColorInput.value;
          
          let finalColor = blendColorWithBackground(color, bgColorInput.value, opacity);
          finalColor = applyGrayscale(finalColor, grayscale);
          
          const div = document.createElement("div");
          div.innerHTML = svgRaw.replace(/CURRENT_COLOR/g, finalColor);
          const svg = div.firstElementChild;
          svg.style.opacity = 1;
          svg.style.filter = "none";
          canvas.appendChild(svg);
        }
      }
      
      updateUI();
    }

    // 获取导出尺寸
    function getExportDimensions() {
      const size = exportSize.value;
      
      if (size === "original") {
        return {
          width: canvas.offsetWidth * 2,
          height: canvas.offsetHeight * 2
        };
      } else if (size === "custom") {
        return {
          width: parseInt(customWidth.value) || 1080,
          height: parseInt(customHeight.value) || 1440
        };
      } else {
        const [width, height] = size.split("x").map(Number);
        return { width, height };
      }
    }

    // 创建高分辨率容器
    function createHighResContainer(targetWidth, targetHeight) {
      const container = document.createElement("div");
      
      container.style.position = "absolute";
      container.style.left = "-9999px";
      container.style.top = "0";
      container.style.width = targetWidth + "px";
      container.style.height = targetHeight + "px";
      container.style.backgroundColor = bgColorInput.value;
      container.style.display = "grid";
      container.style.gridTemplateColumns = "repeat(6, 1fr)";
      container.style.gridTemplateRows = "repeat(8, 1fr)";
      container.style.gap = "2px";
      container.style.boxSizing = "border-box";
      
      const opacity = parseFloat(opacityInput.value);
      const grayscale = parseFloat(grayscaleInput.value);
      
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 6; col++) {
          const isRed = (row + col) % 2 === 0;
          const svgRaw = isRed ? redSVG : greenSVG;
          const color = isRed ? redColorInput.value : greenColorInput.value;
          
          let finalColor = blendColorWithBackground(color, bgColorInput.value, opacity);
          finalColor = applyGrayscale(finalColor, grayscale);
          
          const div = document.createElement("div");
          div.innerHTML = svgRaw.replace(/CURRENT_COLOR/g, finalColor);
          const svg = div.firstElementChild;
          
          svg.style.width = "100%";
          svg.style.height = "100%";
          svg.style.objectFit = "contain";
          svg.style.opacity = 1;
          svg.style.filter = "none";
          
          container.appendChild(svg);
        }
      }
      
      return container;
    }

    // 图片数据存储
    let currentImageDataUrl = '';
    let currentImageBlob = null;

    // 导出图片
    async function exportImage() {
      const includeFrameChecked = includeFrame.checked;
      const includeInfoChecked = includeInfo.checked;
      const { width: targetWidth, height: targetHeight } = getExportDimensions();
      
      exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中';
      exportBtn.disabled = true;
      
      const tempContainer = createHighResContainer(targetWidth, targetHeight);
      document.body.appendChild(tempContainer);
      
      try {
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const canvasData = await html2canvas(tempContainer, {
          backgroundColor: null,
          useCORS: true,
          scale: 1,
          width: targetWidth,
          height: targetHeight,
          logging: false,
          allowTaint: false,
          imageTimeout: 15000,
          ignoreElements: (element) => false
        });
        
        const finalCanvas = document.createElement("canvas");
        const ctx = finalCanvas.getContext("2d");
        
        if (includeFrameChecked || includeInfoChecked) {
          const padding = Math.max(20, targetWidth * 0.02);
          const infoHeight = includeInfoChecked ? Math.max(80, targetHeight * 0.1) : 0;
          const frameWidth = Math.max(2, targetWidth * 0.003);
          
          const patternAreaWidth = targetWidth - 2 * padding;
          const patternAreaHeight = targetHeight - 2 * padding - infoHeight;
          
          const patternScale = Math.min(
            patternAreaWidth / targetWidth,
            patternAreaHeight / targetHeight
          );
          
          const patternWidth = targetWidth * patternScale;
          const patternHeight = targetHeight * patternScale;
          const patternX = (targetWidth - patternWidth) / 2;
          const patternY = padding + (patternAreaHeight - patternHeight) / 2;
          
          finalCanvas.width = targetWidth;
          finalCanvas.height = targetHeight;
          
          if (includeFrameChecked || includeInfoChecked) {
            ctx.fillStyle = "#ffffff";
          } else {
            ctx.fillStyle = bgColorInput.value;
          }
          ctx.fillRect(0, 0, targetWidth, targetHeight);
          
          ctx.drawImage(
            canvasData,
            0, 0, targetWidth, targetHeight,
            patternX, patternY, patternWidth, patternHeight
          );
          
          if (includeFrameChecked) {
            ctx.strokeStyle = "#000000";
            ctx.lineWidth = frameWidth;
            ctx.strokeRect(
              patternX - 5,
              patternY - 5,
              patternWidth + 10,
              patternHeight + 10
            );
          }
          
          if (includeInfoChecked) {
            const infoY = targetHeight - infoHeight + 20;
            const lineHeight = Math.max(20, targetHeight * 0.02);
            const leftPadding = padding;
            const fontSize = Math.max(16, targetWidth * 0.015);
            
            ctx.fillStyle = "#000000";
            ctx.font = `bold ${fontSize}px -apple-system, sans-serif`;
            
            ctx.fillText(`背景色: ${bgColorInput.value}`, leftPadding, infoY);
            ctx.fillText(`红色图案: ${redColorInput.value}`, leftPadding, infoY + lineHeight);
            ctx.fillText(`绿色图案: ${greenColorInput.value}`, leftPadding, infoY + lineHeight * 2);
            ctx.fillText(`透明度: ${parseFloat(opacityInput.value).toFixed(2)}`, leftPadding, infoY + lineHeight * 3);
            ctx.fillText(`灰度: ${parseFloat(grayscaleInput.value).toFixed(2)}`, leftPadding, infoY + lineHeight * 4);
            
            const colorBoxSize = Math.max(20, targetHeight * 0.025);
            const rightPadding = targetWidth - padding - 100;
            
            ctx.fillStyle = bgColorInput.value;
            ctx.fillRect(rightPadding, infoY - 10, colorBoxSize, colorBoxSize);
            ctx.strokeStyle = "#000000";
            ctx.lineWidth = 1;
            ctx.strokeRect(rightPadding, infoY - 10, colorBoxSize, colorBoxSize);
            
            ctx.fillStyle = redColorInput.value;
            ctx.fillRect(rightPadding + 30, infoY - 10, colorBoxSize, colorBoxSize);
            ctx.strokeRect(rightPadding + 30, infoY - 10, colorBoxSize, colorBoxSize);
            
            ctx.fillStyle = greenColorInput.value;
            ctx.fillRect(rightPadding + 60, infoY - 10, colorBoxSize, colorBoxSize);
            ctx.strokeRect(rightPadding + 60, infoY - 10, colorBoxSize, colorBoxSize);
          }
        } else {
          finalCanvas.width = targetWidth;
          finalCanvas.height = targetHeight;
          ctx.fillStyle = bgColorInput.value;
          ctx.fillRect(0, 0, targetWidth, targetHeight);
          ctx.drawImage(canvasData, 0, 0);
        }
        
        currentImageDataUrl = finalCanvas.toDataURL("image/jpeg", 0.92);
        
        finalCanvas.toBlob((blob) => {
          currentImageBlob = blob;
        }, 'image/jpeg', 0.92);
        
        previewImage.src = currentImageDataUrl;
        imagePreviewModal.classList.add('show');
        
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
          saveInstructions.innerHTML = `
            <p><i class="fas fa-mobile-alt"></i> 在手机上：长按图片，然后选择"保存到相册"</p>
            <p><i class="fas fa-info-circle"></i> 提示：您也可以点击"分享图片"按钮保存到相册</p>
          `;
        } else {
          saveInstructions.innerHTML = `
            <p><i class="fas fa-desktop"></i> 在电脑上：右键点击图片，选择"图片另存为"</p>
            <p><i class="fas fa-info-circle"></i> 提示：您也可以点击"下载图片"按钮保存图片</p>
          `;
        }
        
      } catch (error) {
        console.error("生成图片时出错:", error);
        alert("生成图片失败，请重试");
      } finally {
        exportBtn.innerHTML = '<i class="fas fa-download"></i> 导出';
        exportBtn.disabled = false;
        document.body.removeChild(tempContainer);
      }
    }

    // 下载图片
    function downloadImage() {
      if (!currentImageDataUrl) return;
      
      const { width: targetWidth, height: targetHeight } = getExportDimensions();
      const link = document.createElement("a");
      link.download = `pattern_${targetWidth}x${targetHeight}_${Date.now()}.jpg`;
      link.href = currentImageDataUrl;
      link.click();
    }

    // 分享图片
    async function shareImage() {
      if (!currentImageBlob) {
        const response = await fetch(currentImageDataUrl);
        currentImageBlob = await response.blob();
      }
      
      const { width: targetWidth, height: targetHeight } = getExportDimensions();
      const fileName = `pattern_${targetWidth}x${targetHeight}_${Date.now()}.jpg`;
      const file = new File([currentImageBlob], fileName, { type: 'image/jpeg' });
      
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: '图案调色模拟器生成的图片',
            text: '使用图案调色模拟器生成的图片'
          });
        } catch (error) {
          console.log('分享失败:', error);
          downloadImage();
        }
      } else {
        downloadImage();
      }
    }

    // 关闭预览
    function closeImagePreview() {
      imagePreviewModal.classList.remove('show');
    }

    // 重置设置
    function resetSettings() {
      bgColorInput.value = initialValues.bgColor;
      redColorInput.value = initialValues.redColor;
      greenColorInput.value = initialValues.greenColor;
      opacityInput.value = initialValues.opacity;
      grayscaleInput.value = initialValues.grayscale;
      includeFrame.checked = false;
      includeInfo.checked = true;
      exportSize.value = "1080x1440";
      customSize.style.display = "none";
      renderGrid();
    }

    // 切换控制面板（仅在移动端）
    function toggleControlsPanel() {
      if (window.innerWidth >= 768) return; // 桌面端不切换
      
      if (controlsPanel.classList.contains('collapsed')) {
        controlsPanel.classList.remove('collapsed');
        controlsPanel.classList.add('expanded');
      } else {
        controlsPanel.classList.remove('expanded');
        controlsPanel.classList.add('collapsed');
      }
    }

    // 事件监听
    panelToggle.addEventListener('click', toggleControlsPanel);
    
    exportSize.addEventListener("change", function() {
      customSize.style.display = this.value === "custom" ? "block" : "none";
    });

    [bgColorInput, redColorInput, greenColorInput, opacityInput, grayscaleInput].forEach(input => {
      input.addEventListener("input", renderGrid);
    });

    opacityInput.addEventListener("input", updateUI);
    grayscaleInput.addEventListener("input", updateUI);

    exportBtn.addEventListener("click", exportImage);
    resetBtn.addEventListener("click", resetSettings);
    closePreview.addEventListener("click", closeImagePreview);
    downloadImageBtn.addEventListener("click", downloadImage);
    shareImageBtn.addEventListener("click", shareImage);

    imagePreviewModal.addEventListener("click", function(e) {
      if (e.target === imagePreviewModal) {
        closeImagePreview();
      }
    });

    // 窗口大小变化时重新计算布局
    window.addEventListener('resize', function() {
      // 在桌面端，确保控制面板始终展开
      if (window.innerWidth >= 768) {
        controlsPanel.classList.remove('collapsed');
        controlsPanel.classList.add('expanded');
      }
    });

    // 初始化
    renderGrid();
  </script>
</body>
</html>
