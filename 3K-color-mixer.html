<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>背景图案调色模拟器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #2d3436;
      --text-secondary: #636e72;
      --accent-green: #00b894;
      --accent-red: #e17055;
      --accent-blue: #0984e3;
      --border-color: #dfe6e9;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-medium: rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--primary-bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      line-height: 1.5;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 20px;
      width: 100%;
      max-width: 1200px;
      height: 100%;
    }

    .app-header {
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 10px;
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .app-header p {
      margin: 8px 0 0;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
      height: 100%;
    }

    @media (min-width: 992px) {
      .main-content {
        flex-direction: row;
      }
    }

    .controls-panel {
      flex: 0 0 auto;
      background: var(--card-bg);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-light);
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    @media (min-width: 992px) {
      .controls-panel {
        width: 320px;
        max-height: 85vh;
      }
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--accent-blue);
    }

    .color-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .color-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .color-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .color-label span:first-child {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-label i {
      font-size: 1rem;
    }

    .color-input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .color-input-wrapper input[type="color"] {
      width: 50px;
      height: 40px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      padding: 0;
      background: transparent;
      -webkit-appearance: none;
    }

    .color-input-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .color-input-wrapper input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 6px;
    }

    .color-input-wrapper .color-value {
      font-family: monospace;
      font-size: 0.9rem;
      background: var(--primary-bg);
      padding: 8px 12px;
      border-radius: 8px;
      flex: 1;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .slider-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .slider-item {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .slider-label span:first-child {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slider-value {
      font-weight: 600;
      color: var(--accent-blue);
      font-size: 0.9rem;
      min-width: 40px;
      text-align: right;
    }

    .slider-wrapper {
      position: relative;
      height: 40px;
      display: flex;
      align-items: center;
    }

    .slider-wrapper input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      background: linear-gradient(to right, var(--border-color) 0%, var(--accent-blue) 100%);
      border-radius: 3px;
      outline: none;
    }

    .slider-wrapper input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent-blue);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 6px var(--shadow-medium);
    }

    .export-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .export-options {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: var(--primary-bg);
      padding: 16px;
      border-radius: 12px;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid var(--border-color);
      cursor: pointer;
      appearance: none;
      position: relative;
    }

    .checkbox-item input[type="checkbox"]:checked {
      background-color: var(--accent-green);
      border-color: var(--accent-green);
    }

    .checkbox-item input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      color: white;
      font-size: 14px;
      font-weight: bold;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .size-selector {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .size-selector select {
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: white;
      font-size: 0.95rem;
      color: var(--text-primary);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23636e72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px;
    }

    .custom-size-inputs {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .custom-size-inputs label {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .custom-size-inputs input {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 0.95rem;
    }

    .export-button {
      background: linear-gradient(135deg, var(--accent-green), #00a085);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
    }

    .export-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 184, 148, 0.4);
    }

    .export-button:active {
      transform: translateY(0);
    }

    .export-button i {
      font-size: 1.2rem;
    }

    .preview-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      width: 100%;
    }

    .preview-container {
      width: 100%;
      max-width: 500px;
      aspect-ratio: 3 / 4;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow-light);
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .preview-title {
      position: absolute;
      top: 16px;
      left: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .canvas-wrapper {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 2px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px var(--shadow-light);
    }

    .canvas-wrapper svg {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* 触摸设备优化 */
    @media (max-width: 991px) {
      .layout {
        padding: 16px;
        gap: 16px;
      }
      
      .controls-panel {
        padding: 20px;
        max-height: none;
        overflow-y: visible;
      }
      
      .color-input-wrapper input[type="color"] {
        width: 60px;
        height: 48px;
      }
      
      .color-input-wrapper .color-value {
        padding: 12px;
        font-size: 1rem;
      }
      
      .slider-wrapper input[type="range"]::-webkit-slider-thumb {
        width: 28px;
        height: 28px;
      }
      
      .export-button {
        padding: 18px;
        font-size: 1.1rem;
      }
      
      .custom-size-inputs {
        flex-direction: column;
        gap: 10px;
      }
      
      .custom-size-inputs label {
        width: 100%;
      }
      
      .checkbox-item {
        padding: 8px 0;
      }
      
      /* 增加触摸目标大小 */
      input[type="color"],
      input[type="range"],
      select,
      button {
        min-height: 44px;
      }
    }

    /* 小屏幕手机优化 */
    @media (max-width: 480px) {
      .app-header h1 {
        font-size: 1.5rem;
      }
      
      .app-header p {
        font-size: 0.85rem;
      }
      
      .controls-panel {
        padding: 16px;
      }
      
      .color-input-wrapper {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .color-input-wrapper input[type="color"] {
        width: 100%;
        height: 48px;
      }
      
      .color-input-wrapper .color-value {
        width: 100%;
      }
      
      .custom-size-inputs {
        flex-direction: column;
      }
      
      .preview-container {
        padding: 12px;
      }
    }

    /* 滚动条样式 */
    .controls-panel::-webkit-scrollbar {
      width: 6px;
    }

    .controls-panel::-webkit-scrollbar-track {
      background: var(--primary-bg);
      border-radius: 10px;
    }

    .controls-panel::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 10px;
    }

    .controls-panel::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="layout">
    <header class="app-header">
      <h1><i class="fas fa-palette"></i> 图案调色模拟器</h1>
      <p>自定义背景与图案颜色，实时预览并导出高分辨率图片</p>
    </header>
    
    <div class="main-content">
      <div class="controls-panel">
        <div class="color-controls">
          <h3 class="section-title"><i class="fas fa-fill-drip"></i> 颜色设置</h3>
          
          <div class="color-item">
            <div class="color-label">
              <span><i class="fas fa-square" style="color: #f5f0dc;"></i> 背景色</span>
              <span class="color-value" id="bgColorValue">#f5f0dc</span>
            </div>
            <div class="color-input-wrapper">
              <input type="color" id="bgColor" value="#f5f0dc" />
            </div>
          </div>
          
          <div class="color-item">
            <div class="color-label">
              <span><i class="fas fa-heart" style="color: #c1443c;"></i> 红色图案</span>
              <span class="color-value" id="redColorValue">#c1443c</span>
            </div>
            <div class="color-input-wrapper">
              <input type="color" id="redColor" value="#c1443c" />
            </div>
          </div>
          
          <div class="color-item">
            <div class="color-label">
              <span><i class="fas fa-leaf" style="color: #4a7c59;"></i> 绿色图案</span>
              <span class="color-value" id="greenColorValue">#4a7c59</span>
            </div>
            <div class="color-input-wrapper">
              <input type="color" id="greenColor" value="#4a7c59" />
            </div>
          </div>
        </div>
        
        <div class="slider-controls">
          <h3 class="section-title"><i class="fas fa-sliders-h"></i> 效果调整</h3>
          
          <div class="slider-item">
            <div class="slider-label">
              <span><i class="fas fa-adjust"></i> 透明度</span>
              <span class="slider-value" id="opacityValue">1.0</span>
            </div>
            <div class="slider-wrapper">
              <input type="range" id="opacity" min="0" max="1" step="0.05" value="1" />
            </div>
          </div>
          
          <div class="slider-item">
            <div class="slider-label">
              <span><i class="fas fa-tint"></i> 灰度</span>
              <span class="slider-value" id="grayscaleValue">0.0</span>
            </div>
            <div class="slider-wrapper">
              <input type="range" id="grayscale" min="0" max="1" step="0.05" value="0" />
            </div>
          </div>
        </div>
        
        <div class="export-section">
          <h3 class="section-title"><i class="fas fa-download"></i> 导出设置</h3>
          
          <div class="export-options">
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" id="includeFrame" />
                <span>包含外边框</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" id="includeInfo" checked />
                <span>包含参数信息</span>
              </label>
            </div>
            
            <div class="size-selector">
              <label>导出尺寸</label>
              <select id="exportSize">
                <option value="original">原始尺寸</option>
                <option value="750x1000">750 × 1000 (3:4)</option>
                <option value="1080x1440" selected>1080 × 1440 (3:4)</option>
                <option value="1200x1600">1200 × 1600 (3:4)</option>
                <option value="1500x2000">1500 × 2000 (3:4)</option>
                <option value="2250x3000">2250 × 3000 (3:4)</option>
                <option value="3024x4032">3024 × 4032 (3:4)</option>
                <option value="custom">自定义尺寸</option>
              </select>
              
              <div id="customSize" style="display: none;">
                <div class="custom-size-inputs">
                  <label>
                    宽度
                    <input type="number" id="customWidth" min="100" max="5000" value="1080" />
                  </label>
                  <label>
                    高度
                    <input type="number" id="customHeight" min="100" max="5000" value="1440" />
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <button class="export-button" id="exportBtn">
            <i class="fas fa-file-image"></i> 导出为JPG图片
          </button>
        </div>
      </div>
      
      <div class="preview-section">
        <div class="preview-container">
          <div class="preview-title">
            <i class="fas fa-eye"></i> 实时预览
          </div>
          <div class="canvas-wrapper" id="canvas"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const bgColorInput = document.getElementById("bgColor");
    const redColorInput = document.getElementById("redColor");
    const greenColorInput = document.getElementById("greenColor");
    const opacityInput = document.getElementById("opacity");
    const grayscaleInput = document.getElementById("grayscale");
    const exportBtn = document.getElementById("exportBtn");
    const includeFrame = document.getElementById("includeFrame");
    const includeInfo = document.getElementById("includeInfo");
    const exportSize = document.getElementById("exportSize");
    const customSize = document.getElementById("customSize");
    const customWidth = document.getElementById("customWidth");
    const customHeight = document.getElementById("customHeight");
    
    // 颜色值显示元素
    const bgColorValue = document.getElementById("bgColorValue");
    const redColorValue = document.getElementById("redColorValue");
    const greenColorValue = document.getElementById("greenColorValue");
    const opacityValue = document.getElementById("opacityValue");
    const grayscaleValue = document.getElementById("grayscaleValue");

    // 恢复原始SVG
    const redSVG = `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="366.000000pt" height="366.000000pt" viewBox="0 0 366.000000 366.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,366.000000) scale(0.100000,-0.100000)"
fill="CURRENT_COLOR" stroke="none">
<path d="M1071 3021 c-22 -27 -57 -82 -76 -124 -34 -71 -36 -80 -36 -180 l0
-105 -47 -44 c-26 -24 -54 -49 -63 -54 -8 -5 -56 -65 -107 -134 -50 -69 -110
-147 -132 -174 -43 -54 -81 -145 -103 -246 -8 -36 -22 -94 -30 -130 -39 -157
-45 -409 -12 -500 7 -19 21 -64 31 -100 22 -78 51 -118 124 -169 68 -48 248
-141 272 -141 10 0 46 -11 80 -24 83 -31 226 -64 313 -71 39 -4 111 -13 160
-21 152 -24 310 -34 547 -34 187 0 235 -3 268 -16 30 -12 62 -15 123 -12 94 5
157 32 278 119 39 28 83 55 97 62 53 22 82 49 154 143 40 53 87 114 105 137
30 39 59 117 108 291 9 32 23 125 31 205 7 80 19 181 25 224 18 124 -2 248
-61 382 l-22 50 61 119 c34 66 61 124 61 130 0 6 7 25 16 41 22 41 54 134 54
157 0 11 -11 22 -27 28 -16 6 -36 15 -45 20 -33 19 -104 12 -135 -13 -15 -12
-48 -36 -73 -52 -24 -17 -72 -56 -106 -87 -34 -32 -68 -58 -75 -58 -25 1 -123
37 -194 73 -60 30 -87 36 -185 46 -63 6 -124 11 -135 10 -34 -2 -228 19 -280
31 -27 6 -84 10 -125 9 -41 -1 -172 -2 -291 -1 l-216 2 -34 66 c-47 94 -105
155 -167 177 -74 25 -86 23 -131 -32z m168 -123 c53 -58 66 -81 58 -102 -8
-19 -70 -46 -107 -46 -16 0 -42 -11 -58 -25 -51 -43 -62 -31 -42 50 6 22 14
60 19 85 5 25 14 58 20 74 10 24 15 27 38 21 14 -3 47 -29 72 -57z m846 -196
c61 -6 171 -10 245 -10 74 0 153 -5 175 -10 74 -20 158 -52 204 -79 57 -33
155 -105 160 -117 2 -5 14 -19 26 -30 11 -12 34 -39 50 -61 16 -22 43 -56 60
-75 81 -90 110 -199 109 -405 -2 -161 -15 -271 -44 -353 -11 -31 -34 -104 -51
-162 -38 -127 -56 -164 -125 -256 -60 -80 -107 -125 -163 -153 -21 -11 -76
-45 -121 -76 -79 -52 -84 -54 -106 -40 -27 17 -56 19 -70 5 -14 -14 -218 -49
-287 -49 -31 0 -70 7 -85 14 -49 26 -132 39 -158 24 -33 -17 -313 -6 -374 15
-25 9 -65 16 -89 16 -24 0 -71 4 -105 9 -33 6 -96 15 -139 21 -118 17 -218 51
-369 123 -169 80 -226 129 -253 214 -10 32 -24 78 -32 103 -8 25 -17 98 -20
163 -6 124 -1 159 43 317 13 47 24 94 24 106 0 41 78 202 126 262 27 33 65 81
84 107 36 50 98 113 218 223 76 69 164 126 229 148 52 18 120 9 134 -17 12
-23 48 -25 54 -4 3 8 7 21 9 28 4 15 475 15 641 -1z m925 -104 c-6 -13 -15
-35 -21 -50 -12 -31 -39 -37 -59 -14 -21 26 -8 57 30 71 54 19 61 18 50 -7z"/>
<path d="M1314 2294 c-89 -61 -221 -179 -240 -216 -19 -37 -18 -45 11 -64 41
-27 92 -6 148 60 49 56 97 86 141 86 35 0 72 -31 139 -115 35 -43 64 -45 78
-7 5 15 19 34 30 43 18 14 20 20 10 55 -9 33 -19 45 -67 72 -31 18 -67 35 -80
38 -14 4 -30 14 -37 24 -12 17 -68 50 -85 50 -5 0 -27 -12 -48 -26z"/>
<path d="M2293 2166 c-21 -18 -64 -50 -96 -71 -74 -47 -97 -90 -70 -135 9 -16
23 -32 31 -35 16 -6 47 26 86 89 36 60 61 76 128 83 48 5 55 3 78 -21 13 -15
29 -41 35 -59 11 -36 29 -43 68 -28 51 20 29 93 -46 155 -83 68 -155 76 -214
22z"/>
<path d="M1750 1725 c-63 -6 -134 -19 -156 -28 -66 -24 -140 -83 -178 -142
-33 -49 -36 -59 -36 -127 1 -62 6 -83 33 -138 l32 -64 90 -35 c88 -35 93 -35
240 -35 l150 -1 90 37 c163 68 213 162 169 317 -24 84 -43 117 -94 165 -73 69
-114 75 -340 51z m251 -94 c37 -25 105 -123 119 -171 11 -40 -4 -93 -40 -133
-52 -60 -224 -101 -367 -87 -164 15 -243 77 -243 191 0 60 10 83 59 128 78 72
178 101 347 98 77 -2 96 -5 125 -26z"/>
<path d="M1655 1516 c-33 -33 -44 -110 -20 -136 30 -33 62 -26 85 20 27 53 26
104 -2 124 -29 21 -35 20 -63 -8z"/>
<path d="M1892 1503 c-31 -25 -40 -101 -17 -137 32 -49 78 -24 89 49 13 84
-23 128 -72 88z"/>
<path d="M744 1655 c-30 -66 -27 -101 12 -111 18 -5 32 0 48 16 21 19 23 29
21 83 -4 58 -5 62 -30 65 -22 3 -29 -3 -51 -53z"/>
<path d="M905 1637 c2 -64 9 -77 40 -77 31 0 48 32 40 73 -10 44 -23 57 -55
57 -27 0 -27 -1 -25 -53z"/>
<path d="M1030 1664 c6 -14 10 -36 10 -49 0 -27 30 -95 41 -95 18 0 39 34 39
65 0 25 -9 42 -36 69 -44 44 -68 48 -54 10z"/>
<path d="M2594 1591 c2 -69 13 -86 49 -77 25 6 37 30 37 74 0 42 32 22 44 -28
9 -38 15 -45 39 -48 34 -4 42 13 33 72 -8 53 -15 56 -123 63 l-82 6 3 -62z"/>
<path d="M2453 1604 c-7 -19 3 -99 17 -124 15 -28 45 -25 69 6 12 15 21 30 21
34 0 3 -14 28 -31 53 -32 48 -64 61 -76 31z"/>
</g>
</svg>`;

    const greenSVG = `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="315.000000pt" height="315.000000pt" viewBox="0 0 315.000000 315.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,315.000000) scale(0.100000,-0.100000)"
fill="CURRENT_COLOR" stroke="none">
<path d="M761 2716 c-11 -13 -9 -21 9 -51 22 -35 22 -36 3 -63 -16 -24 -18
-50 -18 -257 0 -159 -4 -236 -12 -250 -6 -11 -21 -108 -33 -215 -33 -303 -68
-517 -97 -585 -47 -114 -83 -358 -87 -600 -2 -99 -7 -192 -11 -207 -5 -21 -3
-27 15 -33 39 -12 49 11 49 120 0 55 -2 134 -5 175 -8 122 50 466 100 593 14
34 28 89 31 122 4 33 11 79 16 103 11 51 33 216 53 403 9 75 21 149 28 165 8
20 12 98 13 252 0 187 2 224 15 232 8 5 22 7 30 4 53 -19 458 -35 1025 -40
468 -3 629 -13 655 -40 27 -28 36 -396 11 -428 -5 -6 -11 -36 -15 -66 -8 -63
-65 -383 -101 -570 -36 -185 -36 -194 -49 -548 l-11 -327 -70 -7 c-38 -4 -216
-10 -395 -12 -179 -3 -359 -10 -400 -16 -41 -7 -104 -13 -140 -16 -36 -2 -87
-8 -115 -14 -61 -12 -284 -31 -420 -35 -113 -4 -158 -16 -153 -42 5 -29 48
-44 105 -38 28 3 95 10 150 16 54 5 127 12 163 14 36 2 144 11 240 20 96 8
274 20 395 25 121 5 240 13 265 17 25 4 159 7 298 8 270 0 272 0 272 50 0 39
-16 50 -68 48 l-49 -2 -2 162 c-3 317 18 584 63 787 25 108 55 279 71 395 9
62 23 120 32 135 15 21 17 52 17 190 1 91 -3 185 -8 210 -11 56 -50 109 -94
127 -57 24 -315 33 -482 18 -80 -8 -197 -12 -260 -10 -63 2 -245 9 -405 14
-323 11 -430 22 -513 52 -86 31 -97 32 -111 15z"/>
<path d="M1000 2154 c0 -33 23 -55 94 -89 52 -25 76 -42 80 -58 3 -12 31 -42
63 -67 98 -77 146 -132 226 -254 47 -72 56 -88 61 -117 8 -37 37 -68 66 -71
20 -3 28 5 43 37 10 22 28 50 39 61 10 12 32 48 47 80 20 42 47 76 94 117 92
80 186 143 251 167 48 18 60 20 96 9 24 -7 44 -9 48 -3 14 16 34 85 28 92 -12
12 -138 1 -179 -15 -73 -29 -199 -124 -308 -233 -58 -58 -112 -115 -120 -127
-20 -31 -39 -32 -58 -2 -60 96 -174 226 -262 299 -23 19 -63 56 -88 82 -73 73
-221 136 -221 92z"/>
<path d="M1939 1574 c-13 -15 -41 -37 -61 -50 -45 -29 -57 -64 -34 -99 9 -13
16 -33 16 -44 0 -52 41 -91 96 -91 18 0 32 12 54 47 17 26 30 54 30 64 0 9 8
27 19 40 15 19 17 36 13 82 -4 51 -8 60 -29 68 -43 16 -78 10 -104 -17z"/>
<path d="M1200 1508 c-65 -68 -75 -101 -40 -133 27 -25 103 -32 134 -12 33
22 56 95 49 157 l-6 50 -38 0 c-34 0 -46 -7 -99 -62z"/>
<path d="M1439 1164 c-91 -69 -193 -168 -221 -213 -21 -33 -21 -34 -2 -48 32
-24 56 -11 117 65 55 68 153 152 176 152 17 0 78 -58 133 -127 48 -61 94 -93
133 -93 11 0 15 10 15 37 0 29 -9 46 -47 88 -27 28 -74 83 -107 123 -76 94
-94 95 -197 16z"/>
</g>
</svg>`;

    // 颜色工具函数
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? [
        parseInt(result[1], 16),
        parseInt(result[2], 16),
        parseInt(result[3], 16)
      ] : [0, 0, 0];
    }

    function rgbToHex(r, g, b) {
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    // 计算与背景色混合后的颜色
    function blendColorWithBackground(color, bgColor, opacity) {
      const [r1, g1, b1] = hexToRgb(color);
      const [r2, g2, b2] = hexToRgb(bgColor);
      
      // 标准alpha混合公式: result = foreground * alpha + background * (1 - alpha)
      const r = Math.round(r1 * opacity + r2 * (1 - opacity));
      const g = Math.round(g1 * opacity + g2 * (1 - opacity));
      const b = Math.round(b1 * opacity + b2 * (1 - opacity));
      
      return rgbToHex(r, g, b);
    }

    // 应用灰度效果
    function applyGrayscale(color, grayscale) {
      if (grayscale <= 0) return color;
      
      const [r, g, b] = hexToRgb(color);
      
      // 标准灰度转换公式
      const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
      
      // 混合原色和灰度
      const r2 = Math.round(r * (1 - grayscale) + gray * grayscale);
      const g2 = Math.round(g * (1 - grayscale) + gray * grayscale);
      const b2 = Math.round(b * (1 - grayscale) + gray * grayscale);
      
      return rgbToHex(r2, g2, b2);
    }

    function updateColorValues() {
      bgColorValue.textContent = bgColorInput.value;
      redColorValue.textContent = redColorInput.value;
      greenColorValue.textContent = greenColorInput.value;
      opacityValue.textContent = parseFloat(opacityInput.value).toFixed(2);
      grayscaleValue.textContent = parseFloat(grayscaleInput.value).toFixed(2);
    }

    function renderGrid() {
      console.log("渲染网格，透明度:", opacityInput.value, "灰度:", grayscaleInput.value);
      
      canvas.innerHTML = "";
      canvas.style.backgroundColor = bgColorInput.value;
      const opacity = parseFloat(opacityInput.value);
      const grayscale = parseFloat(grayscaleInput.value);

      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 6; col++) {
          const isRed = (row + col) % 2 === 0;
          const svgRaw = isRed ? redSVG : greenSVG;
          const color = isRed ? redColorInput.value : greenColorInput.value;
          
          // 计算最终颜色：先与背景色混合，再应用灰度
          let finalColor = blendColorWithBackground(color, bgColorInput.value, opacity);
          finalColor = applyGrayscale(finalColor, grayscale);
          
          const div = document.createElement("div");
          div.innerHTML = svgRaw.replace(/CURRENT_COLOR/g, finalColor);
          const svg = div.firstElementChild;
          
          // 不再使用CSS opacity和filter，因为颜色已经计算好了
          svg.style.opacity = 1;
          svg.style.filter = "none";
          
          canvas.appendChild(svg);
        }
      }
      
      updateColorValues();
    }

    function getExportDimensions() {
      const size = exportSize.value;
      
      if (size === "original") {
        return {
          width: canvas.offsetWidth * 2,
          height: canvas.offsetHeight * 2
        };
      } else if (size === "custom") {
        return {
          width: parseInt(customWidth.value) || 1080,
          height: parseInt(customHeight.value) || 1440
        };
      } else {
        const [width, height] = size.split("x").map(Number);
        return { width, height };
      }
    }

    // 创建高分辨率临时容器
    function createHighResContainer(targetWidth, targetHeight) {
      console.log("创建高分辨率容器，尺寸:", targetWidth, "x", targetHeight);
      console.log("透明度:", opacityInput.value, "灰度:", grayscaleInput.value);
      
      const container = document.createElement("div");
      
      container.style.position = "absolute";
      container.style.left = "-9999px";
      container.style.top = "0";
      container.style.width = targetWidth + "px";
      container.style.height = targetHeight + "px";
      container.style.backgroundColor = bgColorInput.value;
      container.style.display = "grid";
      container.style.gridTemplateColumns = "repeat(6, 1fr)";
      container.style.gridTemplateRows = "repeat(8, 1fr)";
      container.style.gap = "2px";
      container.style.boxSizing = "border-box";
      
      const opacity = parseFloat(opacityInput.value);
      const grayscale = parseFloat(grayscaleInput.value);
      
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 6; col++) {
          const isRed = (row + col) % 2 === 0;
          const svgRaw = isRed ? redSVG : greenSVG;
          const color = isRed ? redColorInput.value : greenColorInput.value;
          
          // 使用相同的颜色计算逻辑
          let finalColor = blendColorWithBackground(color, bgColorInput.value, opacity);
          finalColor = applyGrayscale(finalColor, grayscale);
          
          const div = document.createElement("div");
          div.innerHTML = svgRaw.replace(/CURRENT_COLOR/g, finalColor);
          const svg = div.firstElementChild;
          
          svg.style.width = "100%";
          svg.style.height = "100%";
          svg.style.objectFit = "contain";
          svg.style.opacity = 1;
          svg.style.filter = "none";
          
          console.log(`SVG[${row},${col}] 最终颜色:`, finalColor, "原始颜色:", color);
          
          container.appendChild(svg);
        }
      }
      
      return container;
    }

    async function exportImage() {
      const includeFrameChecked = includeFrame.checked;
      const includeInfoChecked = includeInfo.checked;
      const { width: targetWidth, height: targetHeight } = getExportDimensions();
      
      console.log("开始导出图片");
      console.log("目标尺寸:", targetWidth, "x", targetHeight);
      console.log("透明度:", opacityInput.value, "灰度:", grayscaleInput.value);
      console.log("包含边框:", includeFrameChecked, "包含信息:", includeInfoChecked);
      
      // 显示导出中状态
      const originalText = exportBtn.innerHTML;
      exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 导出中...';
      exportBtn.disabled = true;
      
      // 创建高分辨率临时容器
      const tempContainer = createHighResContainer(targetWidth, targetHeight);
      document.body.appendChild(tempContainer);
      
      try {
        // 等待容器完全渲染
        await new Promise(resolve => setTimeout(resolve, 100));
        
        console.log("开始html2canvas截图...");
        const canvasData = await html2canvas(tempContainer, {
          backgroundColor: null,
          useCORS: true,
          scale: 1,
          width: targetWidth,
          height: targetHeight,
          logging: false,
          allowTaint: false,
          imageTimeout: 15000,
          ignoreElements: (element) => false
        });
        
        console.log("html2canvas截图完成，开始处理最终图片");
        
        const finalCanvas = document.createElement("canvas");
        const ctx = finalCanvas.getContext("2d");
        
        if (includeFrameChecked || includeInfoChecked) {
          const padding = Math.max(20, targetWidth * 0.02);
          const infoHeight = includeInfoChecked ? Math.max(80, targetHeight * 0.1) : 0;
          const frameWidth = Math.max(2, targetWidth * 0.003);
          
          const patternAreaWidth = targetWidth - 2 * padding;
          const patternAreaHeight = targetHeight - 2 * padding - infoHeight;
          
          const patternScale = Math.min(
            patternAreaWidth / targetWidth,
            patternAreaHeight / targetHeight
          );
          
          const patternWidth = targetWidth * patternScale;
          const patternHeight = targetHeight * patternScale;
          const patternX = (targetWidth - patternWidth) / 2;
          const patternY = padding + (patternAreaHeight - patternHeight) / 2;
          
          finalCanvas.width = targetWidth;
          finalCanvas.height = targetHeight;
          
          // 对于JPG格式，确保背景是实色
          if (includeFrameChecked || includeInfoChecked) {
            ctx.fillStyle = "#ffffff";
          } else {
            ctx.fillStyle = bgColorInput.value;
          }
          ctx.fillRect(0, 0, targetWidth, targetHeight);
          
          // 绘制图案
          ctx.drawImage(
            canvasData,
            0, 0, targetWidth, targetHeight,
            patternX, patternY, patternWidth, patternHeight
          );
          
          if (includeFrameChecked) {
            ctx.strokeStyle = "#000000";
            ctx.lineWidth = frameWidth;
            ctx.strokeRect(
              patternX - 5,
              patternY - 5,
              patternWidth + 10,
              patternHeight + 10
            );
          }
          
          if (includeInfoChecked) {
            const infoY = targetHeight - infoHeight + 20;
            const lineHeight = Math.max(20, targetHeight * 0.02);
            const leftPadding = padding;
            const fontSize = Math.max(16, targetWidth * 0.015);
            
            ctx.fillStyle = "#000000";
            ctx.font = `bold ${fontSize}px Arial, sans-serif`;
            
            ctx.fillText(`背景色: ${bgColorInput.value}`, leftPadding, infoY);
            ctx.fillText(`红色图案: ${redColorInput.value}`, leftPadding, infoY + lineHeight);
            ctx.fillText(`绿色图案: ${greenColorInput.value}`, leftPadding, infoY + lineHeight * 2);
            ctx.fillText(`透明度: ${parseFloat(opacityInput.value).toFixed(2)}`, leftPadding, infoY + lineHeight * 3);
            ctx.fillText(`灰度: ${parseFloat(grayscaleInput.value).toFixed(2)}`, leftPadding, infoY + lineHeight * 4);
            
            const colorBoxSize = Math.max(20, targetHeight * 0.025);
            const rightPadding = targetWidth - padding - 100;
            
            ctx.fillStyle = bgColorInput.value;
            ctx.fillRect(rightPadding, infoY - 10, colorBoxSize, colorBoxSize);
            ctx.strokeStyle = "#000000";
            ctx.lineWidth = 1;
            ctx.strokeRect(rightPadding, infoY - 10, colorBoxSize, colorBoxSize);
            
            ctx.fillStyle = redColorInput.value;
            ctx.fillRect(rightPadding + 30, infoY - 10, colorBoxSize, colorBoxSize);
            ctx.strokeRect(rightPadding + 30, infoY - 10, colorBoxSize, colorBoxSize);
            
            ctx.fillStyle = greenColorInput.value;
            ctx.fillRect(rightPadding + 60, infoY - 10, colorBoxSize, colorBoxSize);
            ctx.strokeRect(rightPadding + 60, infoY - 10, colorBoxSize, colorBoxSize);
          }
        } else {
          finalCanvas.width = targetWidth;
          finalCanvas.height = targetHeight;
          
          // 对于JPG格式，确保背景是实色
          ctx.fillStyle = bgColorInput.value;
          ctx.fillRect(0, 0, targetWidth, targetHeight);
          
          ctx.drawImage(canvasData, 0, 0);
        }
        
        // 下载图片 - 改为JPG格式
        const link = document.createElement("a");
        link.download = `pattern_${targetWidth}x${targetHeight}_${Date.now()}.jpg`;
        // 使用0.92的质量参数，这是JPG的推荐质量设置
        link.href = finalCanvas.toDataURL("image/jpeg", 0.92);
        link.click();
        
        console.log("JPG图片导出完成");
        
        // 显示成功提示
        const successMessage = document.createElement("div");
        successMessage.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: var(--accent-green);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 8px;
          animation: slideIn 0.3s ease;
        `;
        successMessage.innerHTML = `<i class="fas fa-check-circle"></i> JPG图片导出成功`;
        document.body.appendChild(successMessage);
        
        setTimeout(() => {
          successMessage.style.animation = "slideOut 0.3s ease";
          setTimeout(() => document.body.removeChild(successMessage), 300);
        }, 3000);
        
      } catch (error) {
        console.error("导出图片时出错:", error);
        
        // 显示错误提示
        const errorMessage = document.createElement("div");
        errorMessage.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: var(--accent-red);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 8px;
          animation: slideIn 0.3s ease;
        `;
        errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> 导出失败: ${error.message}`;
        document.body.appendChild(errorMessage);
        
        setTimeout(() => {
          errorMessage.style.animation = "slideOut 0.3s ease";
          setTimeout(() => document.body.removeChild(errorMessage), 300);
        }, 5000);
      } finally {
        // 恢复按钮状态
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
        
        // 清理临时容器
        document.body.removeChild(tempContainer);
      }
    }

    // 添加动画样式
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // 显示/隐藏自定义尺寸输入
    exportSize.addEventListener("change", function() {
      customSize.style.display = this.value === "custom" ? "block" : "none";
    });

    // 添加输入事件监听
    [bgColorInput, redColorInput, greenColorInput, opacityInput, grayscaleInput].forEach(input => {
      input.addEventListener("input", renderGrid);
    });

    // 颜色选择器点击后立即更新
    [bgColorInput, redColorInput, greenColorInput].forEach(input => {
      input.addEventListener("change", updateColorValues);
    });

    // 滑块值实时显示
    opacityInput.addEventListener("input", function() {
      opacityValue.textContent = parseFloat(this.value).toFixed(2);
      renderGrid();
    });
    
    grayscaleInput.addEventListener("input", function() {
      grayscaleValue.textContent = parseFloat(this.value).toFixed(2);
      renderGrid();
    });

    exportBtn.addEventListener("click", exportImage);

    // 初始化渲染
    renderGrid();
  </script>
</body>
</html>